<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My AI Assistant Hub</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>

    <!-- Custom styles for the app -->
    <style>
      body {
        font-family: "Inter", "sans-serif";
        /* More colorful gradient background */
        background: linear-gradient(125deg, #e0c3fc 0%, #8ec5fc 100%);
        background-attachment: fixed; /* Keeps gradient smooth on scroll */
      }
      /* Simple loading spinner */
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #3b82f6; /* blue-500 */
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      /* Class to show/hide loading */
      .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 50px;
      }

      /* Fade-in animation for tab content */
      .tab-content {
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body class="min-h-screen p-4 md:p-8">
    <div
      class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden"
    >
      <!-- Header -->
      <header
        class="p-6 bg-gradient-to-r from-indigo-600 to-blue-700 text-white"
      >
        <h1 class="text-3xl font-bold">My AI Assistant Hub</h1>
        <p class="mt-1 text-indigo-100">
          Your personal tool to get things done.
        </p>
      </header>

      <!-- Tab Navigation -->
      <nav class="flex border-b border-gray-200">
        <button
          data-tab="search"
          class="tab-button active-tab flex-1 py-4 px-6 font-semibold text-gray-700 focus:outline-none text-center transition-colors duration-200 flex items-center justify-center gap-2"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
          Web Search
        </button>
        <button
          data-tab="planner"
          class="tab-button flex-1 py-4 px-6 font-semibold text-gray-500 focus:outline-none text-center transition-colors duration-200 flex items-center justify-center gap-2"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          Planner
        </button>
        <button
          data-tab="summarizer"
          class="tab-button flex-1 py-4 px-6 font-semibold text-gray-500 focus:outline-none text-center transition-colors duration-200 flex items-center justify-center gap-2"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M12 20h9"></path>
            <path
              d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
            ></path>
          </svg>
          Summarizer
        </button>
      </nav>

      <!-- Tab Content -->
      <div class="p-6 md:p-8">
        <!-- ======================= -->
        <!--   Search Tab (Default)  -->
        <!-- ======================= -->
        <div id="search-content" class="tab-content">
          <p class="text-gray-600 mb-4">
            Ask me anything! I'll search the web for the latest information.
          </p>
          <div class="flex flex-col md:flex-row gap-2">
            <input
              type="text"
              id="search-query"
              placeholder="e.g., 'What are the top AI trends in 2025?'"
              class="flex-1 w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <button
              id="search-button"
              class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all duration-200 shadow-sm hover:shadow-md transform hover:-translate-y-0.5"
            >
              Search
            </button>
          </div>

          <!-- Search Output -->
          <div class="mt-6">
            <div id="search-loading" class="loading-container hidden">
              <div class="spinner"></div>
            </div>
            <div
              id="search-error"
              class="text-red-600 font-semibold hidden"
            ></div>
            <div
              id="search-output"
              class="bg-gray-50 p-4 rounded-lg border border-gray-200 hidden"
            >
              <p
                id="search-result-text"
                class="text-gray-800 whitespace-pre-wrap"
              ></p>

              <!-- Sources -->
              <div id="search-sources-container" class="mt-4 hidden">
                <h4 class="font-semibold text-gray-700">Sources:</h4>
                <ul
                  id="search-result-sources"
                  class="list-disc list-inside mt-2 text-sm space-y-1"
                >
                  <!-- Sources will be injected here -->
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- ======================= -->
        <!--       Planner Tab       -->
        <!-- ======================= -->
        <div id="planner-content" class="tab-content hidden">
          <p class="text-gray-600 mb-4">
            What do you need to plan? I can help create schedules, brainstorm
            lists, or outline projects.
          </p>
          <textarea
            id="planner-prompt"
            rows="4"
            placeholder="e.g., 'Help me plan my week. I have a big project due Friday and a dentist appointment on Wednesday.'"
            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          ></textarea>
          <button
            id="planner-button"
            class="mt-4 bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-all duration-200 shadow-sm hover:shadow-md transform hover:-translate-y-0.5"
          >
            Generate Plan
          </button>

          <!-- Planner Output -->
          <div class="mt-6">
            <div id="planner-loading" class="loading-container hidden">
              <div class="spinner"></div>
            </div>
            <div
              id="planner-error"
              class="text-red-600 font-semibold hidden"
            ></div>
            <p
              id="planner-output"
              class="bg-gray-50 p-4 rounded-lg border border-gray-200 min-h-[150px] text-gray-800 whitespace-pre-wrap hidden"
            ></p>
          </div>
        </div>

        <!-- ======================= -->
        <!--     Summarizer Tab      -->
        <!-- ======================= -->
        <div id="summarizer-content" class="tab-content hidden">
          <p class="text-gray-600 mb-4">
            Paste the text you want me to summarize below.
          </p>
          <textarea
            id="summarizer-text"
            rows="8"
            placeholder="Paste a long article, email, or document here..."
            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          ></textarea>
          <button
            id="summarizer-button"
            class="mt-4 bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition-all duration-200 shadow-sm hover:shadow-md transform hover:-translate-y-0.5"
          >
            Summarize
          </button>

          <!-- Summarizer Output -->
          <div class="mt-6">
            <div id="summarizer-loading" class="loading-container hidden">
              <div class="spinner"></div>
            </div>
            <div
              id="summarizer-error"
              class="text-red-600 font-semibold hidden"
            ></div>
            <p
              id="summarizer-output"
              class="bg-gray-50 p-4 rounded-lg border border-gray-200 min-h-[150px] text-gray-800 whitespace-pre-wrap hidden"
            ></p>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript Logic -->
    <script type="module">
      // --- Configuration ---
      const API_KEY = "AIzaSyCiZU1UrXuwzvsgSAJ6tj-72PLH0FAJgnQ"; // Leave as-is, Canvas will provide the key
      const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
      const MAX_RETRIES = 5;

      // --- DOM Elements ---
      const tabButtons = document.querySelectorAll(".tab-button");
      const tabContents = document.querySelectorAll(".tab-content");

      // Search Tab
      const searchButton = document.getElementById("search-button");
      const searchInput = document.getElementById("search-query");
      const searchLoading = document.getElementById("search-loading");
      const searchError = document.getElementById("search-error");
      const searchOutput = document.getElementById("search-output");
      const searchResultText = document.getElementById("search-result-text");
      const searchSourcesContainer = document.getElementById(
        "search-sources-container"
      );
      const searchResultSources = document.getElementById(
        "search-result-sources"
      );

      // Planner Tab
      const plannerButton = document.getElementById("planner-button");
      const plannerPrompt = document.getElementById("planner-prompt");
      const plannerLoading = document.getElementById("planner-loading");
      const plannerError = document.getElementById("planner-error");
      const plannerOutput = document.getElementById("planner-output");

      // Summarizer Tab
      const summarizerButton = document.getElementById("summarizer-button");
      const summarizerText = document.getElementById("summarizer-text");
      const summarizerLoading = document.getElementById("summarizer-loading");
      const summarizerError = document.getElementById("summarizer-error");
      const summarizerOutput = document.getElementById("summarizer-output");

      // --- Tab Switching Logic ---
      tabButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const tab = button.dataset.tab;

          // Update button styles
          tabButtons.forEach((btn) => {
            btn.classList.remove("active-tab", "text-gray-700");
            btn.classList.add("text-gray-500");
            if (btn === button) {
              btn.classList.add("active-tab", "text-gray-700");
              btn.classList.remove("text-gray-500");
            }
          });

          // Update content visibility
          tabContents.forEach((content) => {
            content.classList.add("hidden");
            if (content.id === `${tab}-content`) {
              content.classList.remove("hidden");
            }
          });
        });
      });

      // --- Style for Active Tab ---
      // We do this in JS to avoid PurgeCSS issues
      const style = document.createElement("style");
      style.innerHTML = `
            .active-tab {
                border-bottom: 3px solid #4f46e5; /* indigo-600 */
                color: #4f46e5; /* indigo-600 */
            }
        `;
      document.head.appendChild(style);

      // --- API Call Function with Retry ---
      /**
       * Calls the Gemini API with exponential backoff.
       * @param {object} payload - The payload to send to the API.
       * @returns {Promise<object>} - The JSON response from the API.
       */
      async function generateContent(payload) {
        let attempt = 0;
        while (attempt < MAX_RETRIES) {
          try {
            const response = await fetch(API_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            if (response.ok) {
              return await response.json();
            }

            // Handle retryable errors
            if (response.status === 429 || response.status >= 500) {
              const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
              await new Promise((res) => setTimeout(res, delay));
              attempt++;
            } else {
              // Non-retryable error
              const errorData = await response.json();
              throw new Error(
                `API Error: ${response.status} - ${
                  errorData.error?.message || "Unknown error"
                }`
              );
            }
          } catch (error) {
            if (attempt + 1 >= MAX_RETRIES) {
              throw new Error(
                `Failed to fetch from API after ${MAX_RETRIES} attempts: ${error.message}`
              );
            }
            // Network or other fetch error, retry
            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
            await new Promise((res) => setTimeout(res, delay));
            attempt++;
          }
        }
        throw new Error(
          `Failed to fetch from API after ${MAX_RETRIES} attempts.`
        );
      }

      // --- Helper to display API response ---
      function displayResult(loadingEl, errorEl, outputEl, text) {
        loadingEl.classList.add("hidden");
        errorEl.classList.add("hidden");
        outputEl.textContent = text;
        outputEl.classList.remove("hidden");
      }

      // --- Helper to display API error ---
      function displayError(loadingEl, errorEl, outputEl, error) {
        loadingEl.classList.add("hidden");
        outputEl.classList.add("hidden");
        errorEl.textContent = `Error: ${error.message}`;
        errorEl.classList.remove("hidden");
      }

      // --- Event Handlers for Buttons ---

      // 1. Web Search
      searchButton.addEventListener("click", async () => {
        const query = searchInput.value;
        if (!query) return;

        // Reset UI
        searchLoading.classList.remove("hidden");
        searchError.classList.add("hidden");
        searchOutput.classList.add("hidden");
        searchResultSources.innerHTML = "";
        searchSourcesContainer.classList.add("hidden");

        const payload = {
          contents: [{ parts: [{ text: query }] }],
          tools: [{ google_search: {} }],
        };

        try {
          const result = await generateContent(payload);
          const candidate = result.candidates?.[0];

          if (candidate && candidate.content?.parts?.[0]?.text) {
            const text = candidate.content.parts[0].text;
            displayResult(searchLoading, searchError, searchOutput, text);
            searchResultText.textContent = text; // Set text content

            // Process and display sources
            const groundingMetadata = candidate.groundingMetadata;
            if (groundingMetadata && groundingMetadata.groundingAttributions) {
              const sources = groundingMetadata.groundingAttributions
                .map((attr) => attr.web)
                .filter((web) => web && web.uri && web.title);

              if (sources.length > 0) {
                sources.forEach((source) => {
                  const li = document.createElement("li");
                  const a = document.createElement("a");
                  a.href = source.uri;
                  a.textContent = source.title;
                  a.target = "_blank";
                  a.rel = "noopener noreferrer";
                  a.className = "text-blue-600 hover:underline";
                  li.appendChild(a);
                  searchResultSources.appendChild(li);
                });
                searchSourcesContainer.classList.remove("hidden");
              }
            }
          } else {
            throw new Error("No valid content received from API.");
          }
        } catch (error) {
          displayError(searchLoading, searchError, searchOutput, error);
        }
      });

      // 2. Planner
      plannerButton.addEventListener("click", async () => {
        const prompt = plannerPrompt.value;
        if (!prompt) return;

        plannerLoading.classList.remove("hidden");
        plannerError.classList.add("hidden");
        plannerOutput.classList.add("hidden");

        const payload = {
          contents: [{ parts: [{ text: prompt }] }],
          systemInstruction: {
            parts: [
              {
                text: "You are a helpful planning assistant. Generate clear, organized plans, lists, or schedules based on the user's request. Use formatting like bullet points or numbered lists where appropriate.",
              },
            ],
          },
        };

        try {
          const result = await generateContent(payload);
          const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
          if (text) {
            displayResult(plannerLoading, plannerError, plannerOutput, text);
          } else {
            throw new Error("No valid content received from API.");
          }
        } catch (error) {
          displayError(plannerLoading, plannerError, plannerOutput, error);
        }
      });

      // 3. Summarizer
      summarizerButton.addEventListener("click", async () => {
        const textToSummarize = summarizerText.value;
        if (!textToSummarize) return;

        summarizerLoading.classList.remove("hidden");
        summarizerError.classList.add("hidden");
        summarizerOutput.classList.add("hidden");

        const payload = {
          contents: [{ parts: [{ text: textToSummarize }] }],
          systemInstruction: {
            parts: [
              {
                text: "You are a helpful assistant. Summarize the following text concisely and accurately. Focus on the main points.",
              },
            ],
          },
        };

        try {
          const result = await generateContent(payload);
          const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
          if (text) {
            displayResult(
              summarizerLoading,
              summarizerError,
              summarizerOutput,
              text
            );
          } else {
            throw new Error("No valid content received from API.");
          }
        } catch (error) {
          displayError(
            summarizerLoading,
            summarizerError,
            summarizerOutput,
            error
          );
        }
      });
    </script>
  </body>
</html>
